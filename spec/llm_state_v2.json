{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/arborrhythms/WikiOracle/main/spec/llm_state_v2.json",
  "title": "WikiOracle LLM State v2 (JSONL)",
  "description": "Hierarchical dialogue state. Grammar: Dialogue → Conversation*, Conversation → (Query|Response)* + Conversation* (children). JSONL: header line, then conversation and truth records. Conversations reference parent via 'parent' field; root conversations omit it.",
  "type": "object",
  "required": ["version", "schema", "time", "title", "context", "conversations", "truth"],
  "properties": {
    "version": {
      "type": "integer",
      "const": 2,
      "description": "Schema version."
    },
    "schema": {
      "type": "string",
      "format": "uri",
      "description": "URL to the canonical JSON Schema file."
    },
    "time": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 UTC timestamp of last modification."
    },
    "title": {
      "type": "string",
      "description": "Human-readable document title. Shown in root summary and browser tab.",
      "default": "WikiOracle"
    },
    "context": {
      "type": "string",
      "description": "XHTML fragment injected into every query."
    },
    "selected_conversation": {
      "type": ["string", "null"],
      "default": null,
      "description": "ID of the currently viewed conversation, or null for root (empty chat)."
    },
    "conversations": {
      "type": "array",
      "description": "Ordered tree of conversations. Each element is a root conversation; children are nested.",
      "items": { "$ref": "#/$defs/conversation" }
    },
    "truth": {
      "type": "array",
      "description": "Flat array of truth entries.",
      "items": { "$ref": "#/$defs/truthEntry" }
    }
  },
  "$defs": {
    "conversation": {
      "type": "object",
      "required": ["id", "messages"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique conversation ID (UUID recommended)."
        },
        "title": {
          "type": "string",
          "description": "Human-readable conversation title. Optional; derived from first user message if absent."
        },
        "messages": {
          "type": "array",
          "description": "Ordered sequence of query/response messages within this conversation.",
          "items": { "$ref": "#/$defs/message" }
        },
        "children": {
          "type": "array",
          "description": "Child conversations (branches from this conversation).",
          "items": { "$ref": "#/$defs/conversation" },
          "default": []
        }
      }
    },
    "message": {
      "type": "object",
      "required": ["id", "role", "username", "time", "content"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Stable unique message ID (UUID recommended)."
        },
        "role": {
          "type": "string",
          "enum": ["user", "assistant"],
          "description": "Speaker role."
        },
        "username": {
          "type": "string",
          "description": "Speaker identifier."
        },
        "time": {
          "type": "string",
          "format": "date-time"
        },
        "content": {
          "type": "string",
          "description": "XHTML fragment."
        }
      }
    },
    "truthEntry": {
      "type": "object",
      "required": ["id", "title", "time", "certainty", "content"],
      "properties": {
        "id": { "type": "string", "description": "Unique truth entry ID (UUID recommended)." },
        "title": { "type": "string" },
        "time": { "type": "string", "format": "date-time" },
        "certainty": { "type": "number", "minimum": -1.0, "maximum": 1.0 },
        "content": { "type": "string", "description": "Self-describing XHTML element with id, certainty, and title attributes on the root tag. Recognized root tags: <fact> (plain assertion), <reference href> (external link), <and>/<or>/<not>/<non> with <child id> children (Strong Kleene operators), <provider> (LLM config), <authority> (external trust table, DID/ORCID + URL to remote llm.jsonl). Envelope id/certainty/title are synced from content during normalization." }
      }
    }
  }
}
